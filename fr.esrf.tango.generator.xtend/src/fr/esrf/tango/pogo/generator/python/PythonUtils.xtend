//+======================================================================
//
// Project:   Tango
//
// Description:  source code for Tango code generator.
//
// $Author: verdier $
//
// Copyright (C) :  2004,2005,2006,2007,2008,2009,2009,2010,2011,2012,2013,2014
//					European Synchrotron Radiation Facility
//                  BP 220, Grenoble 38043
//                  FRANCE
//
// This file is part of Tango.
//
// Tango is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
// 
// Tango is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
// 
// You should have received a copy of the GNU General Public License
// along with Tango.  If not, see <http://www.gnu.org/licenses/>.
//
// $Revision: $
// $Date:  $
//
// $HeadURL: $
//
//-======================================================================

package fr.esrf.tango.pogo.generator.python

import fr.esrf.tango.pogo.pogoDsl.Command
import fr.esrf.tango.pogo.pogoDsl.Attribute
import fr.esrf.tango.pogo.pogoDsl.ForwardedAttribute
import fr.esrf.tango.pogo.pogoDsl.PogoDeviceClass
import fr.esrf.tango.pogo.pogoDsl.ForwardedAttribute
import fr.esrf.tango.pogo.pogoDsl.Property
import fr.esrf.tango.pogo.pogoDsl.Pipe
import com.google.inject.Inject
import static extension fr.esrf.tango.pogo.generator.python.PythonTypeDefinitions.*
import static extension fr.esrf.tango.pogo.generator.common.StringUtils.*
import org.eclipse.emf.common.util.BasicEList

class PythonUtils {
    @Inject extension fr.esrf.tango.pogo.generator.common.StringUtils
    @Inject extension ProtectedArea
    @Inject extension ProtectedAreaHL
    @Inject extension fr.esrf.tango.pogo.generator.python.PythonTypeDefinitions    
	@Inject	extension fr.esrf.tango.pogo.generator.python.PyUtils
        
   
    def commentMultiLinesPython(PogoDeviceClass cls){
        cls.description.description.replaceAll("\n","\n#                ");
    }
      
    def formatComaToPoint(String str){
    	if (str !== null)
    	{
	    	if (str.contains(","))
	    	{
	    		return str.replaceAll(",",".");
	    	}
	    	else
	    	{
	    		return str;
	    	}
    	}
    	else
    	{
    		return str;
    	}
    }   
      
    def stringListToStringArray(String str){
    	if (str !== null)
    	{
	    	if (str.contains(","))
	    	{
	    		return "[\"" + str.substring(1, str.length()-1).replaceAll(", ",",").replaceAll(",","\", \"") + "\"]";
	    	}
	    	else if (str.contains(" "))
	    	{
	    		return "[\"" + str.substring(1, str.length()-1)+"\"]";
	    	}
	    	else
	    	{
	    		return "[" + str + "]";
	    	}
    	}
    	else
    	{
    		return str;
    	}
    }
     
    def stringToPyth(String str){
    	if (str !== null)
    	{
	    	if (str == "true")
	    	{
	    		return "True";
	    	}
	    	else
	    	{
		    	if (str == "false")
		    	{
		    		return "False";
		    	}
		    	else
		    	{
	    			return str;
		    	}
	    	}
    	}
    	else
    	{
    		return str;
    	}
    }

    def commentMultiLinesPythonStr(String str){
    	if (str !== null)
    	{
    		if (!str.empty)
    		{
				return " " + myReplaceAll(str,"\n","\n# ");
    		}
    		else
    		{
    			return "";
    		}
    	}
    	else
    	{
    		return "";
    	}
    }
    def commentMultiLinesInputDescriptionStr(String str){
    	if (str !== null)
    	{
    		if (!str.empty)
    		{
				return "" + myReplaceAll(str,"\n","\"\n               \"");
    		}
    		else
    		{
    			return "" ;
    		}
    	}
    	else
    	{
    		return "" ;
    	}
    }
    
    def commentMultiLinesOutputDescriptionStr(String str){
    	if (str !== null)
    	{
    		if (!str.empty)
    		{
				return "" + myReplaceAll(str,"\n","\"\n                \"");
    		}
    		else
    		{
    			return "" ;
    		}
    	}
    	else
    	{
    		return "" ;
    	}
    }
        
    def commentCmdParamMultiLines(String str){
    	if (str.contains("\n"))
    	{
    		return "    " + myReplaceAll(str, "\n","\n    ");
    	}
    	else
    	{
    		return str;
    	}
    }
    
    def isMemorized(Attribute attr) {
        if (attr.write)    {
            if (attr.memorized!==null) {
                if (attr.memorized == "true") {
                    if(attr.memorizedAtInit == "true") {
                        return "    \'Memorized\':\"true\""; 
                    }
                    else {
                        return "    \'Memorized\':\"true_without_hard_applied\"";
                    }
                }
            }
        }
        return "";
    }
    
    def hasAttrPropertySet(Attribute attr){
        return (
        	(attr.memorized!==null && !attr.memorized.empty) ||
            (attr.properties.label !== null && !attr.properties.label.empty)         		||
            (attr.properties.unit !== null && !attr.properties.unit.empty)       		||
            (attr.properties.standardUnit !== null && !attr.properties.standardUnit.empty)		||
            (attr.properties.displayUnit !== null && !attr.properties.displayUnit.empty) 		||
            (attr.properties.format !== null && !attr.properties.format.empty )     		||
            (attr.properties.maxValue !== null && !attr.properties.maxValue.empty )   		||
            (attr.properties.minValue !== null && !attr.properties.minValue.empty )    		||
            (attr.properties.maxAlarm !== null && !attr.properties.maxAlarm.empty )   		||
            (attr.properties.minAlarm !== null && !attr.properties.minAlarm.empty )   		||
            (attr.properties.maxWarning !== null && !attr.properties.maxWarning.empty ) 		||
            (attr.properties.minWarning !== null && !attr.properties.minWarning.empty ) 		||
            (attr.properties.deltaTime !== null && !attr.properties.deltaTime.empty  ) 		||
            (attr.properties.deltaValue !== null && !attr.properties.deltaValue.empty ) 		||
            (attr.properties.description !== null && !attr.properties.description.empty ) 		||
            !attr.polledPeriod.equals("0")     		||
            attr.eventCriteria!==null           		||
            attr.eventCriteria!==null);
    }
    
    def hasAttrPropertySetHL(Attribute attr){
        return (
        	(attr.memorized!==null && !attr.memorized.empty) ||
            (attr.properties.label !== null && !attr.properties.label.empty)         		||
            (attr.properties.unit !== null && !attr.properties.unit.empty)       		||
            (attr.properties.standardUnit !== null && !attr.properties.standardUnit.empty)		||
            (attr.properties.displayUnit !== null && !attr.properties.displayUnit.empty) 		||
            (attr.properties.format !== null && !attr.properties.format.empty )     		||
            (attr.properties.maxValue !== null && !attr.properties.maxValue.empty )   		||
            (attr.properties.minValue !== null && !attr.properties.minValue.empty )    		||
            (attr.properties.maxAlarm !== null && !attr.properties.maxAlarm.empty )   		||
            (attr.properties.minAlarm !== null && !attr.properties.minAlarm.empty )   		||
            (attr.properties.maxWarning !== null && !attr.properties.maxWarning.empty ) 		||
            (attr.properties.minWarning !== null && !attr.properties.minWarning.empty ) 		||
            (attr.properties.deltaTime !== null && !attr.properties.deltaTime.empty  ) 		||
            (attr.properties.deltaValue !== null && !attr.properties.deltaValue.empty ) 		||
            (attr.properties.description !== null && !attr.properties.description.empty ) 		||
            attr.displayLevel.equals("EXPERT") 		||
            !attr.polledPeriod.equals("0")     		||
            attr.eventCriteria!==null           		||
            attr.getAttType().equals("Spectrum")	||
            attr.getAttType().equals("Image")		||
            attr.eventCriteria!==null)				||
            (attr.enumLabels !== null && attr.enumLabels.size > 0);
    }
    
    def hasCmdPropertySet(Command cmd){
        return (cmd.displayLevel.equals("EXPERT") || !cmd.polledPeriod.equals("0"));
    }
    
    def hasCmdArginOrArgoutSet(Command cmd){
        return (!cmd.argin.type.voidType || !cmd.argout.type.voidType );
    }
    
    def hasPipePropertySetHL(Pipe pip){
        return (
            (pip.label !== null && !pip.label.empty) 		||
            (pip.description !== null && !pip.description.empty ) 		||
            pip.displayLevel.equals("EXPERT") 		||
            (pip.rwType.contains("WRITE"))
            )
    }
    
    def enumLabelsWithNumber(Attribute attr){
    	var enumVal = 0
    	var String labelList = ""
    	for(label: attr.enumLabels){
    		labelList = labelList + label + " = " + enumVal.toString +"\n"
    		enumVal = enumVal +1
   		}
    	return labelList
    }
    
    def enumLabelWithInvalidChars (Attribute attr){
    	var enumVal = 0
    	var String labelList = ""
    	for(label: attr.enumLabels){
    		labelList = labelList + "(\""+ label + "\", " + enumVal.toString +"),\n"
    		enumVal = enumVal +1
   		}
	    return labelList
    }
    
    def String checkEnumLabels (Attribute attr){
    	var flag = "valid"
    	for(label: attr.enumLabels){
    	 	if(label.contains("-")||label.contains("+")||label.contains("=")||label.contains("%")||label.contains("*")||label.charAt(0).toString.matches("[0-9]")){
    	 	flag = "invalid"
    		}
    	}
    	return flag
    }
    
    def enumAttrCheck (PogoDeviceClass cls){
    	var enumAttr = false
    	for(attr:cls.attributes){
    		if(attr.dataType.pythonTypeHL.equalsIgnoreCase("'DevEnum'")){
    			enumAttr = true
    		}
    	}
    	return enumAttr    	
    }
     
    def commandExecution(PogoDeviceClass cls, Command cmd) '''
		def Â«cmd.methodNameÂ»(selfÂ«IF !cmd.argin.type.voidTypeÂ», arginÂ«ENDIFÂ»):
		    """ Â«cmd.descriptionÂ»
		    Â«IF !cmd.argin.type.voidTypeÂ»
		    :param argin: Â«cmd.argin.description.commentCmdParamMultiLinesÂ»
		    :type argin: Â«cmd.argin.type.pythonTypeÂ»
		    Â«ENDIFÂ»
		    Â«IF !cmd.argout.type.voidTypeÂ»
		    Â«IF cmd.argout.description.emptyÂ»
		    :rtype: Â«cmd.argout.type.pythonTypeÂ»
		    Â«ELSEÂ»
		    :return: Â«cmd.argout.description.commentCmdParamMultiLinesÂ»
		    :rtype: Â«cmd.argout.type.pythonTypeÂ»
		    Â«ENDIFÂ»
		    Â«ENDIFÂ»
		    """
		    self.debug_stream("In Â«cmd.methodNameÂ»()")
		    Â«IF !cmd.argout.type.voidTypeÂ»argout = Â«cmd.argout.type.defaultValueÂ»Â«ENDIFÂ»
		    Â«protectedArea(cls, cmd.name)Â»
		    Â«cmd.returnMethodCodeÂ»
        '''

    def projectTittle(PogoDeviceClass cls) '''
            Â«IF cls.description.title != ""Â»
            #  Project :     Â«cls.description.titleÂ»
            #
            Â«ELSEÂ»
            #
            Â«ENDIFÂ»
        '''
        
    def commandExecutionHL(PogoDeviceClass cls, Command cmd) '''
Â«IF isTrue(cmd.status.concreteHere)Â»
	Â«IF cmd.name != "State"Â»
		Â«IF cmd.name != "Status"Â»    @commandÂ«IF cmd.hasCommandArgÂ»(Â«ENDIFÂ»
		Â«IF !cmd.argin.type.voidTypeÂ»        dtype_in=Â«cmd.argin.type.pythonTypeHLÂ»,
		Â«IF !cmd.argin.description.emptyÂ»        doc_in="Â«cmd.argin.description.commentMultiLinesInputDescriptionStrÂ»",
		Â«ENDIFÂ»
		Â«ENDIFÂ»
		Â«IF !cmd.argout.type.voidTypeÂ»        dtype_out=Â«cmd.argout.type.pythonTypeHLÂ»,
		Â«IF !cmd.argout.description.emptyÂ»        doc_out="Â«cmd.argout.description.commentMultiLinesOutputDescriptionStrÂ»",
		Â«ENDIFÂ»
		Â«ENDIFÂ»
        Â«setAttrPropertyHL("display_level", cmd.displayLevel, false)Â»
        Â«setAttrPropertyHL("polling_period", cmd.polledPeriod, false)Â»
		Â«IF cmd.hasCommandArgÂ»    )
		Â«ENDIFÂ»
		Â«ENDIFÂ»
	Â«ENDIFÂ»
    @DebugIt()
    def Â«cmd.methodNameÂ»(selfÂ«IF !cmd.argin.type.voidTypeÂ», arginÂ«ENDIFÂ»):
        Â«IF cls.description.filestogenerate.toLowerCase.contains("protected regions")Â»
        Â«openProtectedAreaHL(cls,cmd.name)Â»
        """
        Â«cmd.description.commentCmdParamMultiLinesÂ»
        Â«IF !cmd.argin.type.voidTypeÂ»

        :param argin: Â«cmd.argin.type.pythonTypeHLÂ»
        Â«cmd.argin.description.commentCmdParamMultiLinesÂ»
        Â«ENDIFÂ»
        Â«IF !cmd.argout.type.voidTypeÂ»

        :return:Â«cmd.argout.type.pythonTypeHLÂ»
        Â«cmd.argout.description.commentCmdParamMultiLinesÂ»
        Â«ELSEÂ»

        :return:None
        Â«ENDIFÂ»
        """
        Â«cmd.argout.type.defaultValueReturnHLÂ»
        Â«closeProtectedAreaHL(cls,cmd.name)Â»
        Â«ELSEÂ»
        Â«IF !cmd.argout.type.voidTypeÂ»
        return Â«cmd.argout.type.defaultValueTestHLÂ»
        Â«ELSEÂ»
        pass
        Â«ENDIFÂ»
        Â«ENDIFÂ»
Â«ENDIFÂ»

'''
    
    def commandMethodStateMachine(PogoDeviceClass cls, Command cmd) '''
		def is_Â«cmd.nameÂ»_allowed(self):
		    self.debug_stream("In is_Â«cmd.nameÂ»_allowed()")
		    state_ok = not(Â«cmd.excludedStates.ifContentFromListPythonÂ»)
		    Â«protectedArea(cls, "is_" + cmd.name + "_allowed")Â»
		    return state_ok
		    
    '''
    
    def commandMethodStateMachineHL(PogoDeviceClass cls, Command cmd) '''
		def is_Â«cmd.nameÂ»_allowed(self):
        Â«IF cls.description.filestogenerate.toLowerCase.contains("protected regions")Â»Â«protectedAreaHL(cls,"is_" + cmd.name + "_allowed", "return " + cmd.excludedStates.ifContentFromListPythonHL, false)Â»Â«ELSEÂ»return Â«cmd.excludedStates.ifContentFromListPythonHLÂ»Â«ENDIFÂ»
		
'''
    
    def writeAttributeMethod(PogoDeviceClass cls, Attribute attribute) '''
		def write_Â«attribute.nameÂ»(self, attr):
		    self.debug_stream("In write_Â«attribute.nameÂ»()")
		    data = attr.get_write_value()
		    Â«protectedArea(cls, attribute.name + "_write")Â»
    '''
    def writeAttributeMethodHL(PogoDeviceClass cls, Attribute attribute, boolean isDynamic) '''
        def write_Â«attribute.nameÂ»(self, Â«IF isDynamicÂ»w_attrÂ«ELSEÂ»valueÂ«ENDIFÂ»):
                Â«IF cls.description.filestogenerate.toLowerCase.contains("protected regions")Â»
                Â«openProtectedAreaHL(cls, attribute.name + "_write")Â»
                """Set the Â«attribute.nameÂ» attribute."""
                Â«IF isDynamic==falseÂ»
                pass
                Â«ELSEÂ»
                """Example implementation:
                name = w_attr.get_name()
                Hint: self.attr_Â«attribute.nameÂ» should be define on the top level
                (initialize_dynamic_attributes, init_device method or constructor)
                self.attr_Â«attribute.nameÂ» = w_attr.get_write_value()
                """
                pass
                Â«ENDIFÂ»
                Â«closeProtectedAreaHL(cls, attribute.name + "_write")Â»
                Â«ELSEÂ»
                pass
                Â«ENDIFÂ»
    '''
        
    def readAttributeMethod(PogoDeviceClass cls, Attribute attribute) '''
		def read_Â«attribute.nameÂ»(self, attr):
		    self.debug_stream("In read_Â«attribute.nameÂ»()")
		    Â«protectedArea(cls, attribute.name + "_read", attribute.setAttrVal, false)Â»
    '''
    def readAttributeMethodHL(PogoDeviceClass cls, Attribute attribute, boolean isDynamic) '''
        def read_Â«attribute.nameÂ»(selfÂ«IF isDynamicÂ», attrÂ«ENDIFÂ»):
                Â«IF cls.description.filestogenerate.toLowerCase.contains("protected regions")Â»
                Â«openProtectedAreaHL(cls, attribute.name + "_read")Â»
                Â«IF isDynamic==falseÂ»
                """Return the Â«attribute.nameÂ» attribute."""
                return self._Â«attribute.pythonAttributeVariableNameHLÂ»
                Â«ELSEÂ»
                """Return the Â«attribute.nameÂ»_read attribute."""
                """Example implementation:
                Hint: self.attr_Â«attribute.nameÂ» should be define on the top level
                (initialize_dynamic_attributes, init_device method or constructor)
                attr.set_value(self.attr_Â«attribute.nameÂ»)
                return attr
                """
                attr.set_value(Â«attribute.defaultValueDimÂ»)
                return attr
                Â«ENDIFÂ»
                Â«closeProtectedAreaHL(cls, attribute.name + "_read")Â»
                Â«ELSEÂ»
                return Â«attribute.defaultValueDimÂ»
                Â«ENDIFÂ»
    '''
      
    def readPipeMethodHL(PogoDeviceClass cls, Pipe pip) '''
        def read_Â«pip.nameÂ»(self):
                Â«IF cls.description.filestogenerate.toLowerCase.contains("protected regions")Â»Â«protectedAreaHL(cls, pip.name + "_read", "return dict(x=0, y=0)", false)Â»Â«ELSEÂ»return dict(x=0, y=0)Â»Â«ENDIFÂ»

    '''
    
    def writePipeMethodHL(PogoDeviceClass cls, Pipe pip) '''
        def write_Â«pip.nameÂ»(self, value):
                Â«IF cls.description.filestogenerate.toLowerCase.contains("protected regions")Â»Â«protectedAreaHL(cls, pip.name + "_write","print dict(value)", false)Â»Â«ELSEÂ»print dict(value)Â»Â«ENDIFÂ»

    '''
    def attributeMethodStateMachine(PogoDeviceClass cls, Attribute attribute) '''
		def is_Â«attribute.nameÂ»_allowed(self, attr):
		    self.debug_stream("In is_Â«attribute.nameÂ»_allowed()")
		    if attr==PyTango.AttReqType.READ_REQ:
		        state_ok = not(Â«attribute.readExcludedStates.ifContentFromListPythonÂ»)
		    else:
		        state_ok = not(Â«attribute.writeExcludedStates.ifContentFromListPythonÂ»)
		    Â«protectedArea(cls, "is_" + attribute.name + "_allowed")Â»
		    return state_ok
		    
    '''
    def readWriteStateMachine(PogoDeviceClass cls, Attribute attribute)
    {
    	if (!attribute.readExcludedStates.empty)
    	{
    		if (!attribute.writeExcludedStates.empty)
    		{
    			return "if attr==attr.READ_REQ:\n    return " + attribute.readExcludedStates.ifContentFromListPythonHL + "\nelse:\n    return " + attribute.writeExcludedStates.ifContentFromListPythonHL;
    		}
    		else
    		{
    			return "if attr==attr.READ_REQ:\n    return " + attribute.readExcludedStates.ifContentFromListPythonHL + "\nelse:\n    return True";
    		}
    		
    	}
    	else
    	{
    		
    		if (!attribute.writeExcludedStates.empty)
    		{
    			return "if attr==attr.READ_REQ:\n    return True\nelse:\n    return " + attribute.writeExcludedStates.ifContentFromListPythonHL;
    		}
    		else
    		{
    			return "if attr==attr.READ_REQ:\n    return True\nelse:\n    return True";
    		}
    	}
    }
    
    def readWriteStateMachinePipe(PogoDeviceClass cls, Pipe pip)
    {
    	if (!pip.readExcludedStates.empty)
    	{
    		if (!pip.writeExcludedStates.empty)
    		{
    			return "if attr==attr.READ_REQ:\n    return " + pip.readExcludedStates.ifContentFromListPythonHL + "\nelse:\n    return " + pip.writeExcludedStates.ifContentFromListPythonHL;
    		}
    		else
    		{
    			return "if attr==attr.READ_REQ:\n    return " + pip.readExcludedStates.ifContentFromListPythonHL + "\nelse:\n    return True";
    		}
    		
    	}
    	else
    	{
    		
    		if (!pip.writeExcludedStates.empty)
    		{
    			return "if attr==attr.READ_REQ:\n    return True\nelse:\n    return " + pip.writeExcludedStates.ifContentFromListPythonHL;
    		}
    		else
    		{
    			return "if attr==attr.READ_REQ:\n    return True\nelse:\n    return True";
    		}
    	}
    }

    def attributeMethodStateMachineHL(PogoDeviceClass cls, Attribute attribute) '''
		def is_Â«attribute.nameÂ»_allowed(self, attr):
        Â«IF attribute.rwType.equals("READ")Â»Â«IF cls.description.filestogenerate.toLowerCase.contains("protected regions")Â»Â«protectedAreaHL(cls, "is_" + attribute.name + "_allowed","return " + attribute.readExcludedStates.ifContentFromListPythonHL, false)Â»Â«ELSEÂ»return Â«attribute.readExcludedStates.ifContentFromListPythonHLÂ»Â«ENDIFÂ»Â«ENDIFÂ»
        Â«IF attribute.rwType.equals("WRITE")Â»Â«IF cls.description.filestogenerate.toLowerCase.contains("protected regions")Â»Â«protectedAreaHL(cls, "is_" + attribute.name + "_allowed","return " + attribute.writeExcludedStates.ifContentFromListPythonHL, false)Â»Â«ELSEÂ»return Â«attribute.writeExcludedStates.ifContentFromListPythonHLÂ»Â«ENDIFÂ»Â«ENDIFÂ»
        Â«IF attribute.rwType.equals("READ_WRITE") || attribute.rwType.equals("READ_WITH_WRITE")Â»Â«IF cls.description.filestogenerate.toLowerCase.contains("protected regions")Â»Â«protectedAreaHL(cls, "is_" + attribute.name + "_allowed",cls.readWriteStateMachine(attribute), false)Â»Â«ELSEÂ»Â«cls.readWriteStateMachine(attribute)Â»Â«ENDIFÂ»Â«ENDIFÂ»

    '''
    def pipeMethodStateMachineHL(PogoDeviceClass cls, Pipe pip) '''
		def is_Â«pip.nameÂ»_allowed(self, attr):
        Â«IF pip.rwType.equals("READ")Â»Â«IF cls.description.filestogenerate.toLowerCase.contains("protected regions")Â»Â«protectedAreaHL(cls, "is_" + pip.name + "_allowed","return " + pip.readExcludedStates.ifContentFromListPythonHL, false)Â»Â«ELSEÂ»return Â«pip.readExcludedStates.ifContentFromListPythonHLÂ»Â«ENDIFÂ»Â«ENDIFÂ»
        Â«IF pip.rwType.equals("WRITE")Â»Â«IF cls.description.filestogenerate.toLowerCase.contains("protected regions")Â»Â«protectedAreaHL(cls, "is_" + pip.name + "_allowed","return " + pip.writeExcludedStates.ifContentFromListPythonHL, false)Â»Â«ELSEÂ»return Â«pip.writeExcludedStates.ifContentFromListPythonHLÂ»Â«ENDIFÂ»Â«ENDIFÂ»
        Â«IF pip.rwType.equals("READ_WRITE") || pip.rwType.equals("READ_WITH_WRITE")Â»Â«IF cls.description.filestogenerate.toLowerCase.contains("protected regions")Â»Â«protectedAreaHL(cls, "is_" + pip.name + "_allowed",cls.readWriteStateMachinePipe(pip), false)Â»Â«ELSEÂ»Â«cls.readWriteStateMachinePipe(pip)Â»Â«ENDIFÂ»Â«ENDIFÂ»

    '''
    def pythonPropertyClass(Property prop) '''        'Â«prop.nameÂ»':
            [Â«prop.type.pythonPropTypeÂ», 
            Â«IF !prop.description.emptyÂ»"Â«prop.description.oneLineStringÂ»"Â«ELSEÂ» ''Â«ENDIFÂ»Â«IF !prop.defaultPropValue.emptyÂ»,
            Â«IF prop.type.pythonPropType.equals("PyTango.DevString")Â»["Â«prop.defaultPropValue.get(0)Â»"] Â«ELSEIF prop.type.pythonPropType.equals("PyTango.DevVarStringArray")Â»Â«prop.defaultPropValue.toString.stringListToStringArrayÂ»Â«ELSEÂ»Â«prop.defaultPropValueÂ»Â«ENDIFÂ»Â«ELSEÂ»,
            Â«IF prop.mandatory.isTrueÂ»mandatory=True,Â«ENDIFÂ»
            [] Â«ENDIFÂ»],
            Â«IF prop.mandatory.isTrueÂ»mandatory=True,Â«ENDIFÂ»
    '''
    
    def pythonPropertyClassHL(Property prop) '''
Â«IF isTrue(prop.status.concreteHere)Â»
        Â«prop.nameÂ» = class_property(
                dtype=Â«prop.type.pythonPropTypeHLÂ»,
                Â«IF !prop.defaultPropValue.emptyÂ»
                default_value=Â«IF prop.type.pythonPropTypeHL.equals("'DevString'")Â»"Â«prop.defaultPropValue.get(0)Â»"
        Â«ELSEIF prop.type.pythonPropTypeHL.equals("'DevVarStringArray'")Â»
        Â«prop.defaultPropValue.toString.stringListToStringArrayÂ»
        Â«ELSEIF ( prop.type.pythonPropTypeHL.equals("'DevVarShortArray'") || prop.type.pythonPropTypeHL.equals("'DevVarLongArray'") || prop.type.pythonPropTypeHL.equals("'DevVarFloatArray'") || prop.type.pythonPropTypeHL.equals("'DevVarDoubleArray'") )Â»
        Â«prop.defaultPropValue.toStringÂ»
        Â«ELSEÂ»
        Â«prop.defaultPropValue.get(0).stringToPythÂ»
        Â«ENDIFÂ»
        Â«ENDIFÂ»
        Â«IF prop.mandatory.isTrueÂ»        mandatory=TrueÂ«ENDIFÂ»
            )
Â«ENDIFÂ»
    '''
    
     def pythonPropertyClassDocsHL(Property prop) '''
Â«IF isTrue(prop.status.concreteHere)Â»
            Â«prop.nameÂ»
        Â«IF !prop.description.emptyÂ»        - Â«prop.description.oneLineStringÂ»Â«ENDIFÂ»
                - Type:Â«prop.type.pythonPropTypeHLÂ»
Â«ENDIFÂ»
    '''
    
    def pythonPropertyDeviceHL(Property prop) '''
Â«IF isTrue(prop.status.concreteHere)Â»
        Â«prop.nameÂ» = device_property(
                dtype=Â«prop.type.pythonPropTypeHLÂ»,
                Â«IF !prop.defaultPropValue.emptyÂ» 
                default_value=Â«IF prop.type.pythonPropTypeHL.equals("'DevString'")Â»"Â«prop.defaultPropValue.get(0)Â»"
        Â«ELSEIF prop.type.pythonPropTypeHL.equals("'DevVarStringArray'")Â»
        Â«prop.defaultPropValue.toString.stringListToStringArrayÂ»
        Â«ELSEIF ( prop.type.pythonPropTypeHL.equals("'DevVarShortArray'") || prop.type.pythonPropTypeHL.equals("'DevVarLongArray'") || prop.type.pythonPropTypeHL.equals("'DevVarFloatArray'") || prop.type.pythonPropTypeHL.equals("'DevVarDoubleArray'") )Â»
        Â«prop.defaultPropValue.toStringÂ»
        Â«ELSEÂ»
        Â«prop.defaultPropValue.get(0).stringToPythÂ»
        Â«ENDIFÂ»
        Â«ENDIFÂ»
        Â«IF prop.mandatory.isTrueÂ»        mandatory=TrueÂ«ENDIFÂ»
            )
Â«ENDIFÂ»
    '''
    
         def pythonPropertyDeviceDocsHL(Property prop) '''
Â«IF isTrue(prop.status.concreteHere)Â»
            Â«prop.nameÂ»
        Â«IF !prop.description.emptyÂ»        - Â«prop.description.oneLineStringÂ»Â«ENDIFÂ»
                - Type:Â«prop.type.pythonPropTypeHLÂ»
Â«ENDIFÂ»
    '''
    
    def pythonCommandClass(Command cmd) '''        'Â«cmd.nameÂ»':
            [[Â«cmd.argin.type.pythonTypeÂ», "Â«getArgDescription(cmd.argin.description.oneLineString)Â»"],
            [Â«cmd.argout.type.pythonTypeÂ», "Â«getArgDescription(cmd.argout.description.oneLineString)Â»"]Â«IF cmd.hasCmdPropertySetÂ»,
            {
            Â«setAttrProperty("Polling period", cmd.polledPeriod)Â»
            Â«setAttrProperty("Display level", cmd.displayLevel)Â»
            } ],
    Â«ELSEÂ»],Â«ENDIFÂ»
    '''
    
    def String pythonAttributeSize(Attribute attr) {
        if (attr.image) {
            return ", " + attr.maxX + ", " + attr.maxY;
        }
        else
        if (attr.spectrum) {
            return ", " + attr.maxX;
        }
        else
            return "";
    }
    
    def String pythonAttributeSizeHL(Attribute attr) {
        if (attr.image) {
            return "max_dim_x=" + attr.maxX + ", max_dim_y=" + attr.maxY + ",";
        }
        else
        if (attr.spectrum) {
            return "max_dim_x=" + attr.maxX + ",";
        }
        else
            return "";
    }
    
    def String pythonAttributeVariableNameHL(Attribute attr) {
    	var attrVariableName = attr.name
    	var indexList = new BasicEList<Integer>
    	var ch =0 
    	var stringSize = (attr.name.length -1)
    	for (ch =0; ch < attrVariableName.length; ch++){
    		if(Character.isUpperCase(attrVariableName.charAt(ch))){
    			indexList.add(ch);
    		}
    	}
    	var checkNxtIndex = 0
    	var position = 0
    	var count = 0
    	for (index:indexList){
    		if(checkNxtIndex !== stringSize)
    		{   			
	    		if(index==checkNxtIndex){
	    			checkNxtIndex = (index +1)
	    			if(Character.isLowerCase(attr.name.charAt((checkNxtIndex)))){
	    				position = (index + count)
	    				attrVariableName = attrVariableName.substring(0, position)+ '_' + attrVariableName.substring(position)
	    				count+=1
	    			}
	    		}
	    		else{
	    			position = (index + count)
	    			attrVariableName = attrVariableName.substring(0, position)+ '_' + attrVariableName.substring(position)
	    			checkNxtIndex = (index +1)
	    			count+=1
	    		}
    		}
    	}
    	return attrVariableName.toLowerCase
	}

    
    def pythonAttributeClass(Attribute attr) '''        'Â«attr.nameÂ»':
            [[Â«attr.dataType.pythonTypeÂ»,
            PyTango.Â«attr.attType.toUpperCaseÂ»,
            PyTango.Â«attr.rwType.toUpperCaseÂ»Â«pythonAttributeSize(attr)Â»]Â«IF attr.hasAttrPropertySetÂ»,
            {
            Â«setAttrProperty("label", attr.properties.label)Â»
            Â«setAttrProperty("unit", attr.properties.unit)Â»
            Â«setAttrProperty("standard unit", attr.properties.standardUnit)Â»
            Â«setAttrProperty("display unit", attr.properties.displayUnit)Â»
            Â«setAttrProperty("format", attr.properties.format)Â»
            Â«setAttrProperty("max value", attr.properties.maxValue)Â»
            Â«setAttrProperty("min value", attr.properties.minValue)Â»
            Â«setAttrProperty("max alarm", attr.properties.maxAlarm)Â»
            Â«setAttrProperty("min alarm", attr.properties.minAlarm)Â»
            Â«setAttrProperty("max warning", attr.properties.maxWarning)Â»
            Â«setAttrProperty("min warning", attr.properties.minWarning)Â»
            Â«setAttrProperty("delta time", attr.properties.deltaTime)Â»
            Â«setAttrProperty("delta value", attr.properties.deltaValue)Â»
            Â«setAttrProperty("description", attr.properties.description.oneLineString)Â»
            Â«setAttrProperty("Polling period", attr.polledPeriod)Â»
            Â«setAttrProperty("Display level", attr.displayLevel)Â»
            Â«IF attr.eventCriteria!==nullÂ»
            Â«setAttrProperty("period", attr.eventCriteria.period)Â»
            Â«setAttrProperty("rel_change", attr.eventCriteria.relChange)Â»
            Â«setAttrProperty("abs_change", attr.eventCriteria.absChange)Â»
            Â«ENDIFÂ»
            Â«IF attr.evArchiveCriteria!==nullÂ»
            Â«setAttrProperty("archive_period", attr.evArchiveCriteria.period)Â»
            Â«setAttrProperty("archive_rel_change", attr.evArchiveCriteria.relChange)Â»
            Â«setAttrProperty("archive_abs_change", attr.evArchiveCriteria.absChange)Â»
             Â«ENDIFÂ»
            Â«attr.isMemorizedÂ»
            } ],
            Â«ELSEÂ»],Â«ENDIFÂ»
    '''
    
    
    def pythonAttributeClassHL(Attribute attr) '''
Â«attr.nameÂ» = attribute(
        dtype=Â«attr.pythonTypeAttrHLÂ»,
        Â«IF !attr.rwType.toUpperCase.equals("READ")Â»access=AttrWriteType.Â«attr.rwType.toUpperCaseÂ»,Â«ENDIFÂ»
        Â«IF attr.hasAttrPropertySetHLÂ»
        Â«pythonAttributeSizeHL(attr)Â»
        Â«setAttrPropertyHL("display_level", attr.displayLevel, false)Â»
        Â«setAttrPropertyHL("label", attr.properties.label, true)Â»
        Â«setAttrPropertyHL("unit", attr.properties.unit, true)Â»
        Â«setAttrPropertyHL("standard_unit", attr.properties.standardUnit, true)Â»
        Â«setAttrPropertyHL("display_unit", attr.properties.displayUnit, true)Â»
        Â«setAttrPropertyHL("format", attr.properties.format.formatComaToPoint, true)Â»
        Â«setAttrPropertyHL("polling_period", attr.polledPeriod, false)Â»
        Â«IF attr.eventCriteria!==nullÂ»
        Â«setAttrPropertyHL("period", attr.eventCriteria.period, false)Â»
        Â«setAttrPropertyHL("rel_change", attr.eventCriteria.relChange, false)Â»
        Â«setAttrPropertyHL("abs_change", attr.eventCriteria.absChange, false)Â»
        Â«ENDIFÂ»
        Â«IF attr.evArchiveCriteria!==nullÂ»
        Â«setAttrPropertyHL("archive_period", attr.evArchiveCriteria.period, false)Â»
        Â«setAttrPropertyHL("archive_rel_change", attr.evArchiveCriteria.relChange, false)Â»
        Â«setAttrPropertyHL("archive_abs_change", attr.evArchiveCriteria.absChange, false)Â»
        Â«ENDIFÂ»
        Â«setAttrPropertyHL("max_value", attr.properties.maxValue, false)Â»
        Â«setAttrPropertyHL("min_value", attr.properties.minValue, false)Â»
        Â«setAttrPropertyHL("max_alarm", attr.properties.maxAlarm, false)Â»
        Â«setAttrPropertyHL("min_alarm", attr.properties.minAlarm, false)Â»
        Â«setAttrPropertyHL("max_warning", attr.properties.maxWarning, false)Â»
        Â«setAttrPropertyHL("min_warning", attr.properties.minWarning, false)Â»
        Â«setAttrPropertyHL("memorized", attr.memorized, false)Â»
        Â«setAttrPropertyHL("hw_memorized", attr.memorizedAtInit, false)Â»
        Â«setAttrPropertyHL("delta_t", attr.properties.deltaTime, false)Â»
        Â«setAttrPropertyHL("delta_val", attr.properties.deltaValue, false)Â»
        Â«setAttrPropertyHL("doc", attr.properties.description.oneLineString, true)Â»
		Â«ENDIFÂ»
    )
    '''
    def pythonPipeClassHL(Pipe pip) '''
Â«pip.nameÂ» = pipe(
Â«IF pip.hasPipePropertySetHLÂ»        Â«setPipePropertyHL("label", pip.label, true)Â»
        Â«setPipePropertyHL("display_level", pip.displayLevel, false)Â»
        Â«setPipePropertyHL("doc", pip.description.oneLineString, true)Â»
        Â«IF pip.rwType.contains("WRITE")Â»access=PipeWriteType.PIPE_READ_WRITEÂ«ENDIFÂ»
Â«ENDIFÂ»
    )
    '''
    
    
    def pythonForwardedAttributeClassHL(ForwardedAttribute attr) '''
Â«attr.nameÂ» = attribute(
        Â«setAttrPropertyHL("name", attr.name, true)Â»
        Â«setAttrPropertyHL("label", attr.label, true)Â»
        forwarded=True
    )
    '''
    //======================================================
    def setEventCriteria(PogoDeviceClass cls) '''
     Â«FOR attribute: cls.attributesÂ»
        Â«IF attribute.dataReadyEvent!==nullÂ»
            Â«IF attribute.dataReadyEvent.fire!==null && attribute.dataReadyEvent.fire.equals("true")Â»
                self.Â«attribute.nameÂ».set_data_ready_event(True)
            Â«ENDIFÂ»
        Â«ENDIFÂ»
        Â«IF attribute.changeEvent!==nullÂ»
            Â«IF attribute.changeEvent.fire!==null && attribute.changeEvent.fire.equals("true")Â»
                 self.set_change_event("Â«attribute.nameÂ»", True, Â«IF attribute.changeEvent.libCheckCriteria.equals("true")Â»TrueÂ«ELSEÂ»FalseÂ«ENDIFÂ»)
            Â«ENDIFÂ»
        Â«ENDIFÂ»
        Â«IF attribute.archiveEvent!==nullÂ»
            Â«IF attribute.archiveEvent.fire!==null && attribute.archiveEvent.fire.equals("true")Â»
                 self.set_archive_event("Â«attribute.nameÂ»", True, Â«IF attribute.archiveEvent.libCheckCriteria.equals("true")Â»TrueÂ«ELSEÂ»FalseÂ«ENDIFÂ»)
            Â«ENDIFÂ»
        Â«ENDIFÂ»
     Â«ENDFORÂ»
    '''
    //======================================================
    /**
     * Code to generate dynamic attribute example.
     */
    //======================================================
    def dynamicAttributeCreationExample(Attribute attr) '''
        Â«IF attr.scalarÂ»
            myÂ«attr.nameÂ» = PyTango.Attr('MyÂ«attr.nameÂ»', Â«attr.dataType.pythonTypeÂ», PyTango.Â«attr.rwType.toUpperCaseÂ»)
        Â«ENDIFÂ»
        Â«IF attr.spectrumÂ»
            myÂ«attr.nameÂ» = PyTango.SpectrumAttr('MyÂ«attr.nameÂ»', Â«attr.dataType.pythonTypeÂ», PyTango.Â«attr.rwType.toUpperCaseÂ», Â«attr.maxXÂ»)
        Â«ENDIFÂ»
        Â«IF attr.imageÂ»
            myÂ«attr.nameÂ» = PyTango.ImageAttr('MyÂ«attr.nameÂ»', Â«attr.dataType.pythonTypeÂ», PyTango.Â«attr.rwType.toUpperCaseÂ», Â«attr.maxXÂ», Â«attr.maxYÂ»)
        Â«ENDIFÂ»
    '''
    //======================================================
    def dynamicAttributeDefaultValueExample(PogoDeviceClass cls, Attribute attr) '''
        Â«IF attr.displayLevel.equals("EXPERT")Â»
            myÂ«attr.nameÂ».set_disp_level(PyTango.DispLevel.EXPERT)
        Â«ENDIFÂ»
        Â«cls.addDynamicAttributeExample(attr)Â»
        Â«IF attr.readÂ»
            self.attr_Â«attr.nameÂ»_read = Â«attr.defaultValueDimÂ»
        Â«ENDIFÂ»
    '''
    //======================================================
    def dynamicAttributeSetMemorizedExample(Attribute attribute) '''
        Â«IF attribute.writeÂ»
            Â«IF attribute.memorized!==nullÂ»
                Â«IF attribute.memorized == "true"Â»
                    myÂ«attribute.nameÂ».set_memorized()
                    Â«IF attribute.memorizedAtInit == "true"Â»
                        myÂ«attribute.nameÂ».set_memorized_init(True)
                    Â«ELSEÂ»
                        myÂ«attribute.nameÂ».set_memorized_init(False)
                    Â«ENDIFÂ»
                Â«ENDIFÂ»
            Â«ENDIFÂ»
        Â«ENDIFÂ»
    '''
    //======================================================
}
